<!-------------------------------------------------------------------------
# File....................: NMS_uploadAttachmentComponent
# Version.................: 3
# Created by..............: NIIT
# Created Date............: 14/08/2018 
# Last Modified by........: NIIT
# Last Modified Date......: 3/03/2019
# Description.............: This component is used to upload multiple attachment/files on a object record
# VF Page.................: NA
# VF Component............: NMS_uploadAttachmentComponent
# L Comp..................: NA
# Test Class..............: NA
# Change Log..............: Intitial Version, 1.0  
#                           Version 2.0 - support attaching files as well  
                            Version 3.0 - added loading icon
------------------------------------------------------------------------------------>
<apex:component >
    <apex:attribute name="parentID" description="This is the parentid where the attachment should be uploaded." 
                                                                                            type="String" required="true"/>
    <apex:attribute name="filetype" description="filetype = attachment or files" type="String" required="true"/>                                                                                     
    <apex:includeScript value="https://code.jquery.com/jquery-2.2.4.js"/>
    <!--apex:includeScript value="{!URLFOR($Resource.Jquery224)}"/-->

    <!-- CSS for loading icon -->
    <style>
        .overlay {
            display: none;
            height: 100%;
            left: 0;
            position: fixed;
            top: 0;
            opacity: 0.3;
            -moz-opacity: 0.3;
            width: 100%;
            -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=30)";
            filter: alpha(opacity=30);
            background: #000;
            -khtml-opacity: 0.3;
            z-index: 1000;
        }
 
        .loader {
            background: url('/img/loading32.gif') scroll no-repeat 0 0;
            width: 32px;
            height: 32px;
            position: absolute;
            left: 50%;
        }
    </style>
    <!-- CSS for loading icon -->
    
    <script>
    var PARENT_ID = "{!parentID}"; //Set the parent id received through component attribute
    var file_type = "{!filetype}";
    var $jq = jQuery.noConflict();
    //console.log('No Conflict = '+$jq);
    jQuery(document).ready(function($jq) {
       $jq('input').on('change', function(e){
            startLoading();
            for (var i = 0; i < this.files.length; i++) {
                uploading += 1;
                upload_file(this.files[i], PARENT_ID, function(err, res){ 
                    if (uploading === uploaded){
                        console.log('uploaded'); //your operation once finish
                        stopLoading();
                        alert('upload completed');
                    }
                })
            }
        });
        var uploading = 0;
        var uploaded = 0;
        var upload_file = function(file, parentId, callback) {
            filetoBase64(file, function(err, content){
                var attachment_object;
                var urll;
                if(file_type === "attachment"){
                    attachment_object = {
                        parentId: parentId,
                        Body: content, 
                        Name: file.name, 
                        ContentType: file.type 
                    };
                    urll = 'Attachment';
               }else{
                    attachment_object = {
                        FirstPublishLocationId : parentId,                        
                        VersionData : content, 
                        Title: file.name,
                        PathOnClient:file.name                        
                    };
                    urll = 'ContentVersion';
               }
                $jq.ajax({
                    url: '/services/data/v38.0/sobjects/'+urll,
                    data: JSON.stringify(attachment_object),
                    type: 'POST',
                    processData: false,
                    contentType: false,
                    crossDomain: true,
                    //headers: {'Authorization' : 'OAuth {!$Api.Session_ID}', 'Content-Type': 'application/json'},                    
                    headers: {'Authorization': 'Bearer {!$Api.Session_ID}', 'Content-Type': 'application/json'},
                    xhr: function(){
                        var xhr = new window.XMLHttpRequest();
                        //Upload progress
                        xhr.upload.addEventListener("progress", function(evt){
                            if (evt.lengthComputable) {
                                var percentComplete = evt.loaded / evt.total;
                                //Do something with upload progress
                            }
                        }, false);
                        return xhr;
                    },
                    success: function(response) {
                        uploaded += 1;
                        console.log(response); // the id of the attachment
                        callback(null, true)
                    }
                });
            })
        }
        
        var filetoBase64 = function(file, callback){
            var reader = new FileReader();
            reader.onload = function() {
                var fileContents = reader.result;
                var base64Mark = 'base64,';
                var dataStart = fileContents.indexOf(base64Mark) + base64Mark.length;
                fileContents = fileContents.substring(dataStart);
                callback(null, fileContents);
            }
            reader.readAsDataURL(file);
        }
        
        //start of loading icon
        function startLoading() {
            $jq('#load_scrl').css('top', $jq(document).scrollTop() + 200);
            $jq('.loadingBox').show();
        }
        
        //stop of loading icon
        function stopLoading() {
            $jq('.loadingBox').hide();
        }
    });
    </script>
    Add file: <input type="file" multiple="multiple"/>
    <div id="load_scrl" class="loadingBox loader" style="display:none"> </div>
    <div class="loadingBox overlay"> </div>
</apex:component>